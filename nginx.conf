worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Habilitamos sub_filter en los tipos de contenido que nos interesan
    sub_filter_types text/html text/css application/javascript;
    sub_filter_once off;

    server {
        listen 80;

        # Redirecciona la raíz a /admin/login para acceder al panel
        location = / {
            return 302 /admin/login;
        }

        # Proxy para el panel de administración, sin reescritura de URI.
        # Se usa sub_filter para ajustar las URLs de activos en las respuestas.
        location /admin/ {
            proxy_pass http://127.0.0.1:3333;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Elimina el header X-Forwarded-Proto para evitar el error CSRF.
            proxy_set_header X-Forwarded-Proto "";

            # Substituye en la respuesta: convierte href="/… y src="/… en que usen /admin/ como prefijo.
            sub_filter 'href="/' 'href="/admin/';
            sub_filter 'src="/' 'src="/admin/';
        }

        # Resto de las peticiones se envían al servidor de phishing
        location / {
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
